# Makefile for OpenAI Adapter - MiniCPM-o 4.5

.PHONY: help start stop restart status test test-quick test-stream test-curl health clean logs install
.PHONY: minicpm-start minicpm-stop minicpm-restart minicpm-status minicpm-logs debug-llama

# é…ç½®
PYTHON := python3
PIP := pip3
ADAPTER_PORT := 8080
LLAMA_PORT := 19060
LOG_FILE := /tmp/adapter_final.log
MINICPM_DIR := /Users/ftwhmg/houmao/MiniCPM-V-CookBook/demo/web_demo/WebRTC_Demo

# é¢œè‰²è¾“å‡º
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

##@ é€šç”¨å‘½ä»¤

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(GREEN)OpenAI Adapter for MiniCPM-o 4.5$(NC)"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•: make [ç›®æ ‡]"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(YELLOW)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)
	@echo ""

##@ æœåŠ¡ç®¡ç†

start: ## å¯åŠ¨é€‚é…å±‚æœåŠ¡
	@echo "$(GREEN)å¯åŠ¨é€‚é…å±‚...$(NC)"
	@if lsof -ti :$(ADAPTER_PORT) > /dev/null 2>&1; then \
		echo "$(YELLOW)ç«¯å£ $(ADAPTER_PORT) å·²è¢«å ç”¨ï¼Œå…ˆæ¸…ç†...$(NC)"; \
		make stop; \
		sleep 2; \
	fi
	@$(PYTHON) main.py > $(LOG_FILE) 2>&1 &
	@sleep 3
	@if lsof -ti :$(ADAPTER_PORT) > /dev/null 2>&1; then \
		echo "$(GREEN)âœ… é€‚é…å±‚å¯åŠ¨æˆåŠŸ (PID: $$(lsof -ti :$(ADAPTER_PORT)))$(NC)"; \
		make health; \
	else \
		echo "$(RED)âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $(LOG_FILE)$(NC)"; \
		exit 1; \
	fi

stop: ## åœæ­¢é€‚é…å±‚æœåŠ¡
	@echo "$(YELLOW)åœæ­¢é€‚é…å±‚...$(NC)"
	@if lsof -ti :$(ADAPTER_PORT) > /dev/null 2>&1; then \
		lsof -ti :$(ADAPTER_PORT) | xargs kill -9 2>/dev/null || true; \
		sleep 1; \
		echo "$(GREEN)âœ… å·²åœæ­¢$(NC)"; \
	else \
		echo "$(YELLOW)æœåŠ¡æœªè¿è¡Œ$(NC)"; \
	fi

restart: stop start ## é‡å¯é€‚é…å±‚æœåŠ¡

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@echo "$(GREEN)æœåŠ¡çŠ¶æ€æ£€æŸ¥:$(NC)"
	@echo ""
	@echo "$(YELLOW)é€‚é…å±‚ (port $(ADAPTER_PORT)):$(NC)"
	@if lsof -ti :$(ADAPTER_PORT) > /dev/null 2>&1; then \
		echo "  âœ… è¿è¡Œä¸­ (PID: $$(lsof -ti :$(ADAPTER_PORT)))"; \
	else \
		echo "  âŒ æœªè¿è¡Œ"; \
	fi
	@echo ""
	@echo "$(YELLOW)llama-server (port $(LLAMA_PORT)):$(NC)"
	@if lsof -ti :$(LLAMA_PORT) > /dev/null 2>&1; then \
		echo "  âœ… è¿è¡Œä¸­ (PID: $$(lsof -ti :$(LLAMA_PORT)))"; \
	else \
		echo "  âŒ æœªè¿è¡Œ"; \
		echo "  æç¤º: éœ€è¦å…ˆå¯åŠ¨ MiniCPM-o æœåŠ¡"; \
	fi

##@ æµ‹è¯•å‘½ä»¤

test: health ## è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
	@echo ""
	@echo "$(GREEN)è¿è¡Œå®Œæ•´æµ‹è¯•...$(NC)"
	@echo ""
	@$(PYTHON) test_openai_sdk.py
	@echo ""
	@echo "$(GREEN)âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼$(NC)"

test-quick: health ## å¿«é€Ÿæµ‹è¯•ï¼ˆå•æ¬¡å¯¹è¯ï¼‰
	@echo "$(GREEN)å¿«é€Ÿæµ‹è¯•...$(NC)"
	@curl -s http://localhost:$(ADAPTER_PORT)/v1/chat/completions \
		-H "Content-Type: application/json" \
		-d '{"model":"minicpm-o-4.5","messages":[{"role":"user","content":"ä½ å¥½ï¼Œè¯·ç”¨ä¸€å¥è¯ä»‹ç»ä½ è‡ªå·±"}],"max_tokens":50}' \
		| python3 -c 'import sys, json; data=json.load(sys.stdin); print("\nâœ… å“åº”:", data["choices"][0]["message"]["content"]); print("ğŸ“Š Token ä½¿ç”¨:", data["usage"]["total_tokens"])'
	@echo ""

test-stream: health ## æµ‹è¯•æµå¼å“åº”
	@echo "$(GREEN)æµ‹è¯•æµå¼å“åº”...$(NC)"
	@echo ""
	@curl -s http://localhost:$(ADAPTER_PORT)/v1/chat/completions \
		-H "Content-Type: application/json" \
		-d '{"model":"minicpm-o-4.5","messages":[{"role":"user","content":"æ•°åˆ°5"}],"stream":true,"max_tokens":30}' \
		| grep -o '"content":"[^"]*"' | head -20
	@echo ""
	@echo "$(GREEN)âœ… æµå¼å“åº”æ­£å¸¸$(NC)"

test-curl: health ## è¯¦ç»† curl è°ƒè¯•
	@echo "$(GREEN)æµ‹è¯• curl è¯·æ±‚...$(NC)"
	@curl -v http://localhost:$(ADAPTER_PORT)/v1/chat/completions \
		-H "Content-Type: application/json" \
		-d '{"model":"minicpm-o-4.5","messages":[{"role":"user","content":"ä½ å¥½"}],"max_tokens":20}'

health: ## å¥åº·æ£€æŸ¥
	@echo "$(GREEN)å¥åº·æ£€æŸ¥...$(NC)"
	@if ! lsof -ti :$(ADAPTER_PORT) > /dev/null 2>&1; then \
		echo "$(RED)âŒ é€‚é…å±‚æœªè¿è¡Œï¼Œè¯·å…ˆæ‰§è¡Œ: make start$(NC)"; \
		exit 1; \
	fi
	@curl -s http://localhost:$(ADAPTER_PORT)/health | python3 -c 'import sys, json; data=json.load(sys.stdin); print("âœ… é€‚é…å±‚å¥åº·:", data["status"]); print("âœ… llama-server:", data["llama_server"])'

debug-llama: ## ç›´æ¥æµ‹è¯• llama-serverï¼ˆè·³è¿‡é€‚é…å±‚ï¼‰
	@echo "$(GREEN)ç›´æ¥æµ‹è¯• llama-server...$(NC)"
	@curl -s http://localhost:$(LLAMA_PORT)/v1/chat/completions \
		-H "Content-Type: application/json" \
		-d '{"model":"MiniCPM-o-4.5","messages":[{"role":"user","content":"ä½ å¥½"}],"max_tokens":20}' \
		| python3 -m json.tool

##@ å¼€å‘å·¥å…·

logs: ## æŸ¥çœ‹é€‚é…å±‚æ—¥å¿—
	@if [ -f $(LOG_FILE) ]; then \
		tail -f $(LOG_FILE); \
	else \
		echo "$(YELLOW)æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $(LOG_FILE)$(NC)"; \
	fi

clean: stop ## æ¸…ç†æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
	@echo "$(YELLOW)æ¸…ç†ä¸´æ—¶æ–‡ä»¶...$(NC)"
	@rm -f $(LOG_FILE) /tmp/adapter*.log adapter*.log
	@rm -rf __pycache__ *.pyc .pytest_cache
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

install: ## å®‰è£…ä¾èµ–
	@echo "$(GREEN)å®‰è£… Python ä¾èµ–...$(NC)"
	@$(PIP) install -q -r requirements.txt
	@$(PIP) install -q openai
	@echo "$(GREEN)âœ… ä¾èµ–å®‰è£…å®Œæˆ$(NC)"

##@ MiniCPM-o æœåŠ¡ç®¡ç†

minicpm-status: ## æ£€æŸ¥ MiniCPM-o æœåŠ¡çŠ¶æ€
	@echo "$(GREEN)æ£€æŸ¥ MiniCPM-o æœåŠ¡...$(NC)"
	@cd $(MINICPM_DIR) && bash oneclick.sh status

minicpm-logs: ## æŸ¥çœ‹ MiniCPM-o æ—¥å¿—
	@cd $(MINICPM_DIR) && bash oneclick.sh logs

minicpm-start: ## å¯åŠ¨ MiniCPM-o æœåŠ¡
	@echo "$(GREEN)å¯åŠ¨ MiniCPM-o æœåŠ¡...$(NC)"
	@cd $(MINICPM_DIR) && PYTHON_CMD=$(PYTHON) bash oneclick.sh start

minicpm-stop: ## åœæ­¢ MiniCPM-o æœåŠ¡
	@echo "$(YELLOW)åœæ­¢ MiniCPM-o æœåŠ¡...$(NC)"
	@cd $(MINICPM_DIR) && bash oneclick.sh stop

minicpm-restart: ## é‡å¯ MiniCPM-o æœåŠ¡
	@echo "$(GREEN)é‡å¯ MiniCPM-o æœåŠ¡...$(NC)"
	@cd $(MINICPM_DIR) && PYTHON_CMD=$(PYTHON) bash oneclick.sh restart

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help
